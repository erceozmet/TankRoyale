<!DOCTYPE html>
<html>

<head>
	<meta name="viewport" content="width=device-width" />

	<style>
		body {
			font-family: Tahoma, Geneva, sans-serif;
		}
		#gamebox {
			height: 360px; width: 640px; background-color: white;
			border-style: solid; border-width: 5px; position: relative;
			
		}

		#vbar {
			height: 360px; width: 3px; 
			background-color: red; position: absolute;
			
		}
		#hbar {
			height: 3px; width: 640px; 
			background-color: red; position: absolute;
			
		}
	</style>

	<!-- colyseus.js client -->
	<script type="text/javascript" src="https://unpkg.com/colyseus.js@^0.14.0/dist/colyseus.js"></script>
	<script src="https://pixijs.download/release/pixi.min.js"></script>


</head>

<body>
	<div id="gamebox"></div>
	<p>Press W, A, S, D, or the spacebar. The server will send you back which button you pressed.</p>

	<strong>Pressed Buttons</strong><br>
	<div id="buttons"></div>
	<script type="text/javascript" src="static/ex.js"></script>
	<script>
		// pixi decls
		const screen_dims = {width: 640, height: 360};
		const gamebox = document.getElementById("gamebox");
		// pixi initialization
		let app = new PIXI.Application({ width: screen_dims.width, height: screen_dims.height, backgroundColor: 0xffffff });
		gamebox.appendChild(app.view);

		// game map decls
		const tile_dims = {width: 20, height: 20};

		// for (let i = 1; i < tile_dims.width; i++) {
		// 	g = document.createElement('div');
		// 	g.setAttribute("id", "vbar");
		// 	let left = screen_dims.width / tile_dims.width * i;
		// 	g.style.left = left.toString() + "px";
		// 	g.style.top = "0px";
		// 	document.getElementById("gamebox").appendChild(g);  
		// }
		// for (let j = 1; j < tile_dims.height; j++) {
		// 	g = document.createElement('div');
		// 	g.setAttribute("id", "hbar");
		// 	let top = screen_dims.height / tile_dims.height * j;
		// 	g.style.top = top.toString() + "px";
		// 	g.style.left = "0px";
		// 	document.getElementById("gamebox").appendChild(g);  
		// }

		var tiles = new Array(tile_dims.height * tile_dims.width);

		function render_sprite(tile_dims, gameobj, key) {
			// console.log("path", gameobj.imagePath);
			let sprite = PIXI.Sprite.from(gameobj.imagePath); 
			let j = Math.floor(key / tile_dims.width); // TODO use function
			let i = key % tile_dims.width;
			// console.log("i: "+ i + "-- j: " + j);
			sprite.y = screen_dims.height / tile_dims.width * j;
			sprite.x = screen_dims.width / tile_dims.width * i;

			// console.log("x: "+ sprite.x + "-- y: " +sprite.y);
			sprite.height = screen_dims.height / tile_dims.width;
			sprite.width = screen_dims.width / tile_dims.width;
			app.stage.addChild(sprite);

		}


		var host = window.document.location.host.replace(/:.*/, '');

		var client = new Colyseus.Client(location.protocol.replace("http", "ws") + "//" + host + (location.port ? ':' + location.port : ''));
		client.joinOrCreate("battle_room").then(room => {
			console.log("joined");
			room.onStateChange.once(function (state) {
				// console.log("initial room state:", state);
				// document.write(`<div id = "za"><ul>${state.client_adresses.forEach((item) => `<li>${item}</li>`).join('')}</ul></div>`);
			});      
			 
			room.state.map.listen("synced_tiles", (currentValue, previousValue) => {
				currentValue.onAdd = (gameobj, key) => {
					let x = key % room.state.map.width;
					let y = Math.floor(key / room.state.map.width);
					// tiles[key] = gameobj;
					// render_sprite(tile_dims, gameobj, key);
					console.log(gameobj, "has been added at", x, y);
				};
				currentValue.onChange = (gameobj, key) => {
					console.log(gameobj, "has been changed at", key);
				};

				currentValue.onRemove = (gameobj, key) => {
					console.log(gameobj, "has been removed at: ", key)
				}
			});

			room.onStateChange(function (state) {
				// document.write(`<div id = "za"><ul>${state.client_adresses.forEach((item) => `<li>${item}</li>`).join('')}</ul></div>`);
				// this signal is triggered on each patch
			});



			// listen to patches coming from the server
			room.onMessage("buttons", function (message) {
				var p = document.createElement("p");
				p.innerText = message;
				document.querySelector("#buttons").appendChild(p);
			});

			room.onError((code, message) => {
				console.log("oops, error ocurred:");
				console.log(message);
			})
			// send message to room on submit
			document.onkeypress = function (e) {
				e.preventDefault();

				console.log("button:", e.code);

				// send data to room
				room.send("button", e.code);
			}
		});

	</script>
</body>

</html>
